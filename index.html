
<html lang='zh-CN'>
<head>
<title>Versace Translator</title>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
<style>
body, #result, textarea {font-size: 12px; line-height: 20px}
.red {color: red}
.error {background-color: lightpink; padding: 20px; border: 1px solid #cc0000;}
pre {border: 1px solid black; background-color:yellow}
#copy, #result,#transtitle,.error {display: none;}
#run {background-color: green; padding: 5px 20px; font-size:20; color:white;}
</style>
</head>
<body>
<h1>Versace - Jenny Wang</h1>
<button id='run'>run</button>
<br>
<br>
<div class='error'>
</div>
<a href='#mapSection'>Go to mapping</a>
<table>
<tr>
  <td>
<h3 id='transtitle'>Translation</h3>
<button id='copy'>Copy to clipboard</button>
  </td>
  <td>
    <h3>Original</h3>
  </td>
 </tr>
 <tr>
   <td valign='top'>
     <pre id='result'></pre>
   </td>
   <td valign='top'>
    <textarea id='original' rows=10 cols=200></textarea>
   </td>
  </tr>
  </table>
<a href='#run' id='mapSection'>Back to Top</a>
<br>
<br>
<br>

<table>
<thead>
<tr>
  <th width="50%">Fiber Map</th>
  <th width="50%">Material Map</th>
</tr>
<tr>
  <th colspan=2 style='font-size:60%'>(tab or colon separated)</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<textarea id='fiberMap' cols=50 rows=40></textarea>
</td>
<td>
<textarea id='matMap' cols=50 rows=40></textarea>
</td>
</tr>
</table>

<script>

$(function() {
  $.get('example.txt', function(data){
    $('#original').val(data);
  });
  $.get('fiber.tsv', function(data){
    $('#fiberMap').val(data);
  });
  $.get('material.tsv', function(data){
    $('#matMap').val(data);
  });
  function copy() {
      var target = document.getElementById('result');
      var range, select;
      if (document.createRange) {
        range = document.createRange();
        range.selectNode(target)
        select = window.getSelection();
        select.removeAllRanges();
        select.addRange(range);
        document.execCommand('copy');
        select.removeAllRanges();
      } else {
        range = document.body.createTextRange();
        range.moveToElementText(target);
        range.select();
        document.execCommand('copy');
      }
      alert('Translation is copied to clipboard');
  }
  $('#copy').click(copy);
  $('#run').click(function() {
    var fiberMap = {};
    var matMap = {};
    var errors = {};
    var fText = $('#fiberMap').val();
    $(fText.split('\n')).each(function(i,d) {
      var mp = d.split(/\t|:\s*/);
      if(fiberMap[mp[0]]) {
        errors['Duplicate fiber mapping: ' + mp[0]] = 1;
      }
      if (mp[0]) {
        fiberMap[mp[0]] = mp[1];
      }
    });
    var mText = $('#matMap').val();
    $(mText.split('\n')).each(function(i,d) {
      var mp = d.split(/\t|:\s*/);
      if(matMap[mp[0].toUpperCase()]) {
        errors['Duplicate material mapping: ' + mp[0]] = 1;
      }
      if(mp[0]) {
        matMap[mp[0].toUpperCase()] = mp[1];
      }
    });

    $('.error').html('').hide();
    var orig = $('#original').val();
    var arr = orig.split('\n');
    var res = '';

    var titleRE = /(\d\.)?([^\d]*?)( \d)?$/;
    $(arr).each(function(i,d) {
      var items = d.split('; ');
      var sect = [];
      $(items).each(function(j, it){
        var f = it.split(':');
        // f[0] get material section
        // f[1]: comma seperated values
        var comptext = f[0];
        var nn;
        if((nn = titleRE.exec(f[0])) !== null) {
          if (nn.index === titleRE.lastIndex) {
            titleRE.lastIndex++;
          }
          if (matMap[nn[2].toUpperCase()]) {
            comptext = (nn[1] || '' )+ matMap[nn[2].toUpperCase()] + (nn[3] || '');
          } else {
            comptext = "<span class='red'>"+ f[0] + "</span>";
            errors["Material: " + nn[2]] = 1;
          }
        }
        var comp = [];
        var regex = /(\d+%) ([A-Z]+)/gm;
        while ((m = regex.exec(f[1])) !== null) {
          if (m.index === regex.lastIndex) {
            regex.lastIndex++;
          }
          if (fiberMap[m[2]]) {
            comp.push(m[1] + ' ' + fiberMap[m[2]]);
          } else {
            comp.push(m[1] + " <span class='red'>" + m[2] + "</span>")
            errors["Fiber: " + m[2]] = 1;
          }
        }
        comptext += ":" + comp.join(', ');
        sect.push(comptext);
      });
      res += sect.join('; ') + '\n';
    });
    $('#result').html(res).show();
    $('#copy,#transtitle').show();
    if (Object.keys(errors).length) {
      $('.error').append('<h3>Missing Maps</h3>').show();
      $.each(errors, function(key, value) {
        $('.error').append('<div class="red">' + key + '</div>');
      });
    }
    $('#original').height($('#result').height());
  });
});
</script>

</body>
</html>
