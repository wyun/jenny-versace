<html lang='zh-CN'>
<head>
<title>Versace Translator</title>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
</head>
<body>
<h1>Regex Test</h1>
<button id='run'>run</button>
<br>
<br>
Translation:
<br>
<pre id='result'>

</pre>
<br>
Original:
<br>
<textarea id='original' rows=40 cols=200>
Fibers Composition Details
1.Outer Fabric:100% PA; 2.Lining:100% CO; Lining 1:100% CU
1.Outer Fabric:100% PA; 2.Lining:100% CO; Lining 1:100% CU
1.Outer Fabric:100% PA; 2.Lining:100% CO; Lining 1:100% CU
1.Outer Fabric:100% PA; 2.Lining:100% CO; Lining 1:100% CU
1.Outer Fabric:100% PA; 2.Lining:100% CO; Lining 1:100% CU
1.Outer Fabric:100% PA; 2.Lining:100% CO; Lining 1:100% CU
1.Outer Fabric:100% PA; 2.Lining:100% CO; Lining 1:100% CU
1.Outer Fabric:100% PA; 2.Lining:100% CO; Lining 1:100% CU
</textarea>

<br>
<br>
<br>
<table>
<thead>
<tr>
  <th>Fiber Map (copy tab delimited from excel: CODE CNNAME)</th>
  <th>Material Map</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<textarea id='fiberMap' cols=50 rows=40>
</textarea>
</td>
<td>
<textarea id='matMap' cols=20 rows=40>
</textarea>
</td>
</tr>
</table>

<script>

$(function() {
  $('#run').click(function() {
    var fiberMap = {};
    var matMap = {};
    var fText = $('#fiberMap').val();
    $(fText.split('\n')).each(function(i,d) {
      var mp = d.split(/\t|:/);
      fiberMap[mp[0]] = mp[1];
    });
    var mText = $('#matMap').val();
    $(mText.split('\n')).each(function(i,d) {
      var mp = d.split(/\t|:/);
      matMap[mp[0]] = mp[1];
    });

    console.log(fiberMap);
  
    var orig = $('#original').val();
    var arr = orig.split('\n');
    var res = '';

    var titleRE = /(Outer Fabric|Outside|Inner|Lining|Sole|Trim|PADDING|EMBROIDERY)/gm;
    $(arr).each(function(i,d) {
      var items = d.split('; ');
      var sect = [];
      $(items).each(function(j, it){
        var f = it.split(':');
        // f[0] get material section
        // f[1]: comma seperated values
        var comptext = f[0];
        while((nn = titleRE.exec(f[0])) !== null) {
          if (nn.index === titleRE.lastIndex) {
            titleRE.lastIndex++;
          }
          if (matMap[nn[0]) {
            comptext = matMap[nn[0]];
          } else {
          }
        }
        var comp = [];
        var regex = /(\d+%) ([A-Z]+)/gm;
        while ((m = regex.exec(f[1])) !== null) {
          if (m.index === regex.lastIndex) {
            regex.lastIndex++;
          }
          comp.push(m[1] + ' ' + (fiberMap[m[2]] || m[2]));
        }
        comptext += ":" + comp.join(', ');
        sect.push(comptext);
      });
      res += sect.join('; ') + '\n';
    });
    $('#result').html(res);
  });
});
</script>

</body>
</html>
